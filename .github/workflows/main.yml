name: Deploy Frontend to VPS

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add VPS to known_hosts
        run: |
          ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts


      - name: Deploy to VPS
        run: |
          set -e
          
          ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
            set -e
            
            echo 'üöÄ ========== STARTING DEPLOYMENT =========='
            
            DEPLOY_DIR=\"/var/www/jimmystickman.com\"
            
            if [ ! -d \"\$DEPLOY_DIR\" ]; then
              echo 'üìÅ Creating deployment directory...'
              sudo mkdir -p \"\$DEPLOY_DIR\"
              sudo chown -R $USER:$USER \"\$DEPLOY_DIR\"
            fi
            
            cd \"\$DEPLOY_DIR\"
            
            echo 'üìÇ Current directory:'
            pwd
            
            # Initialize git if needed
            if [ ! -d .git ]; then
              echo 'üîß Initializing git repository...'
              git init
              git remote add origin https://github.com/${{ github.repository }}.git
            fi
            
            # Fetch and reset to latest code
            echo '‚¨áÔ∏è Fetching latest code...'
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            
            echo 'üìù Latest commit:'
            git log --oneline -1
            
            # ===== CRITICAL FIX: INSTALL DEPENDENCIES BEFORE CHECKING FILES =====
            echo 'üì¶ Installing ALL dependencies...'
            npm ci
            
            echo 'üîç Checking TypeScript configuration...'
            if [ -f tsconfig.json ]; then
              echo 'üìÑ tsconfig.json found:'
              cat tsconfig.json | grep -A 10 '"paths"'
            elif [ -f jsconfig.json ]; then
              echo 'üìÑ jsconfig.json found:'
              cat jsconfig.json | grep -A 10 '"paths"'
            else
              echo '‚ö†Ô∏è No TypeScript/JavaScript config found!'
            fi
            
            echo 'üîç Checking if @/lib directory exists...'
            find . -type d -name "lib" | head -5
            ls -la ./lib/ 2>/dev/null || echo 'No ./lib directory'
            ls -la ./src/lib/ 2>/dev/null || echo 'No ./src/lib directory'
            
            echo 'üèóÔ∏è Building application...'
            
            if [ \"${{ github.ref_name }}\" == \"dev\" ]; then
              # ===== DEV BRANCH DEPLOYMENT =====
              echo 'üéØ Deploying DEV environment...'
              
              # Use .env.dev if exists
              if [ -f .env.dev ]; then
                echo 'üìÑ Using .env.dev file'
                cp .env.dev .env.local
              else
                echo '‚ö†Ô∏è Warning: .env.dev not found, checking for .env'
                [ -f .env ] && cp .env .env.local || echo 'No .env file found'
              fi
              
              # Build for dev
              BUILD_DIR=build-dev NODE_ENV=production npm run build:dev
              
              # Restart PM2 process
              echo 'üîÑ Managing PM2 dev process...'
              pm2 delete jimmystickman-dev 2>/dev/null || true
              pm2 start npm --name \"jimmystickman-dev\" -- run start:dev
              
            else
              # ===== MAIN BRANCH (PRODUCTION) DEPLOYMENT =====
              echo 'üöÄ Deploying PRODUCTION environment...'
              
              # Use .env.prod if exists
              if [ -f .env.prod ]; then
                echo 'üìÑ Using .env.prod file'
                cp .env.prod .env.local
              else
                echo '‚ö†Ô∏è Warning: .env.prod not found, checking for .env'
                [ -f .env ] && cp .env .env.local || echo 'No .env file found'
              fi
              
              # Build for production
              NODE_ENV=production npm run build:prod
              
              # Restart PM2 process
              echo 'üîÑ Managing PM2 production process...'
              pm2 delete jimmystickman-prod 2>/dev/null || true
              pm2 start npm --name \"jimmystickman-prod\" -- run start:prod
            fi
            
            pm2 save
            
            echo 'üåê Reloading nginx...'
            sudo systemctl reload nginx
            
            echo '‚úÖ ========== DEPLOYMENT COMPLETE =========='
          "

