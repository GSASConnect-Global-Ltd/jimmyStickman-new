# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main
#       - dev

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v2

#     - name: Set up SSH
#       uses: webfactory/ssh-agent@v0.5.3
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: Add VPS to known_hosts
#       run: |
#         ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#     - name: Install dependencies and lint
#       run: |
#         npm install
#         npm run lint
      
#     #install sharp 

#     # - name: Install sharp for image optimization
#     #   run: |
#     #     npm install sharp
  
#     - name: Update Browserslist database
#       run: |
#         npx update-browserslist-db@latest

#     - name: Deploy to VPS
#       run: |
#         ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           cd /var/www/jimmystickman.com &&  # Single directory for both environments
#           git reset --hard &&
#           git pull origin ${{ github.ref_name }} &&  # Pull from the correct branch (dev or main)
#           npm install &&

#           if [ \"${{ github.ref_name }}\" == \"dev\" ]; then
#             # Load environment variables from .env.dev
#             export \$(grep -v '^#' .env.dev | xargs) && 
#             BUILD_DIR=build-dev NODE_ENV=production npm run build:dev &&

#             # Check if the jimmystickman-dev process exists, then restart, otherwise start it
#             if pm2 describe jimmystickman-dev > /dev/null; then
#               pm2 restart jimmystickman-dev
#             else
#               pm2 start npm --name \"jimmystickman-dev\" -- run start:dev  # Start dev process
#             fi
#             pm2 save
#           else
#             # Load environment variables from .env.prod
#             export \$(grep -v '^#' .env.prod | xargs) && 
#             NODE_ENV=production npm run build:prod &&  # Build for production

#             # Check if the jimmystickman-prod process exists, then restart, otherwise start it
#             if pm2 describe jimmystickman-prod > /dev/null; then
#               pm2 restart jimmystickman-prod
#             else
#               pm2 start npm --name \"jimmystickman-prod\" -- run start:prod --port 3000  # Start prod process
#             fi
#             pm2 save
#           fi

#           sudo /bin/systemctl restart nginx  # Restart Nginx to apply changes
#         "

# name: Deploy Next.js
# on:
#   push:
#     branches: [main, dev]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       run: |
#         echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/key
#         chmod 600 /tmp/key
        
#     - name: Deploy
#       run: |
#         BRANCH="${{ github.ref_name }}"
        
#         ssh -i /tmp/key \
#             -o StrictHostKeyChecking=no \
#             ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           # Go to project
#           cd /var/www/jimmystickman.com
          
#           # Update
#           git pull origin $BRANCH
          
#           # Install
#           npm ci --only=production
#           npm install sharp
          
#           # Build
#           npm run build
          
#           # Restart
#           pm2 restart jimmystickman-$BRANCH 2>/dev/null || \
#           pm2 start npm --name \"jimmystickman-$BRANCH\" -- start
          
#           # Reload Nginx
#           sudo systemctl reload nginx
          
#           echo '‚úÖ Next.js deployed!'
#         "


# name: Deploy Next.js
# on:
#   push:
#     branches: [main, dev]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       run: |
#         echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/key
#         chmod 600 /tmp/key
        
#     - name: Deploy
#       run: |
#         BRANCH="${{ github.ref_name }}"
        
#         # Set port based on branch
#         if [ "$BRANCH" = "dev" ]; then
#           PORT=6001
#           APP_NAME="jimmystickman-dev"
#         else
#           PORT=6003
#           APP_NAME="jimmystickman-prod"
#         fi
        
#         echo "Deploying $APP_NAME on port $PORT"
        
#         ssh -i /tmp/key \
#             -o StrictHostKeyChecking=no \
#             ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           # Go to project
#           cd /var/www/jimmystickman.com
          
#           # Update
#           git pull origin $BRANCH
          
#           # Install
#           npm ci --only=production
#           npm install sharp
          
#           # Set port in env
#           echo \"PORT=$PORT\" > .env.local
#           echo \"NEXT_PUBLIC_APP_ENV=$BRANCH\" >> .env.local
          
#           # Build
#           npm run build
          
#           # Stop any existing process on this port
#           sudo lsof -ti:$PORT | xargs sudo kill -9 2>/dev/null || true
          
#           # Start/Restart with PM2
#           pm2 delete $APP_NAME 2>/dev/null || true
#           PORT=$PORT pm2 start npm --name \"$APP_NAME\" -- start
          
#           pm2 save
          
#           echo '‚úÖ Deployed on port $PORT'
#         "

# name: Deploy Next.js
# on:
#   push:
#     branches: [main, dev]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       run: |
#         echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/key
#         chmod 600 /tmp/key
        
#     - name: Deploy
#       run: |
#         BRANCH="${{ github.ref_name }}"
        
#         if [ "$BRANCH" = "dev" ]; then
#           PORT=6001
#           APP_NAME="jimmystickman-dev"
#           ENV_SOURCE=".env.dev"
#           BUILD_ENV="development"
#         else
#           PORT=6003
#           APP_NAME="jimmystickman-prod"
#           ENV_SOURCE=".env.prod"
#           BUILD_ENV="production"
#         fi
        
#         echo "Deploying $APP_NAME on port $PORT from $ENV_SOURCE"
        
#         ssh -i /tmp/key \
#             -o StrictHostKeyChecking=no \
#             ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           cd /var/www/jimmystickman.com
          
#           # Update
#           git pull origin $BRANCH
          
#           # Install
#           npm ci --only=production
#           npm install sharp
          
#           # Create .env.local with source env + port
#           echo 'Creating .env.local...'
          
#           # Start with empty file
#           > .env.local
          
#           # Copy all non-empty lines from source env file
#           if [ -f \"$ENV_SOURCE\" ]; then
#             # Filter out comments and empty lines, add to .env.local
#             grep -v '^#' \"$ENV_SOURCE\" | grep -v '^$' >> .env.local
#             echo \"‚úÖ Merged variables from $ENV_SOURCE\"
#           else
#             echo \"‚ö†Ô∏è  $ENV_SOURCE not found, using defaults\"
#           fi
          
#           # Add/override specific variables
#           echo \"# Deployment overrides\" >> .env.local
#           echo \"PORT=$PORT\" >> .env.local
#           echo \"NEXT_PUBLIC_APP_ENV=$BUILD_ENV\" >> .env.local
          
#           # For Next.js build, we need NODE_ENV=production
#           echo \"NODE_ENV=production\" >> .env.local
          
#           # Display environment (hide sensitive values)
#           echo 'Environment variables (non-sensitive):'
#           grep -E \"^(PORT|NEXT_PUBLIC|NODE_ENV)\" .env.local || echo 'No public vars found'
          
#           # Build with the environment
#           echo 'Building...'
#           npm run build
          
#           # Stop port conflicts
#           sudo lsof -ti:$PORT | xargs sudo kill -9 2>/dev/null || true
          
#           # Start PM2 with the environment
#           pm2 delete $APP_NAME 2>/dev/null || true
          
#           # Load env vars and start
#           export \$(grep -v '^#' .env.local | xargs)
#           pm2 start npm --name \"$APP_NAME\" -- start
          
#           pm2 save
#           echo '‚úÖ Deployed on port $PORT using $ENV_SOURCE'
#         "

# name: Deploy Next.js
# on:
#   push:
#     branches: [main, dev]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Setup SSH
#       uses: webfactory/ssh-agent@v0.5.3
#       with:
#          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
  
#     - name: Deploy
#       run: |
#         BRANCH="${{ github.ref_name }}"
        
#         if [ "$BRANCH" = "dev" ]; then
#           PORT=6001
#           APP_NAME="jimmystickman-dev"
#           ENV_SOURCE=".env.dev"
#           BUILD_SCRIPT="build:dev"
#           START_SCRIPT="start:dev"
#         else
#           PORT=6003
#           APP_NAME="jimmystickman-prod"
#           ENV_SOURCE=".env.prod"
#           BUILD_SCRIPT="build:prod"
#           START_SCRIPT="start:prod"
#         fi
        
#         echo "Deploying $APP_NAME using $START_SCRIPT"
        
#         ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           cd /var/www/jimmystickman.com
          
#           git pull origin $BRANCH
#           npm ci --only=production
#           npm install sharp
          
#           # Copy env file
#           [ -f \"$ENV_SOURCE\" ] && cp \"$ENV_SOURCE\" .env.local
          
#           # Build
#           npm run $BUILD_SCRIPT
          
#           # Stop and start
#           sudo lsof -ti:$PORT | xargs sudo kill -9 2>/dev/null || true
#           pm2 delete $APP_NAME 2>/dev/null || true
#           pm2 start npm --name \"$APP_NAME\" -- run $START_SCRIPT
          
#           pm2 save
#           echo '‚úÖ Deployed using $START_SCRIPT on port $PORT'
#         "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main
#       - dev

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v2

#     - name: Set up SSH
#       uses: webfactory/ssh-agent@v0.5.3
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: Add VPS to known_hosts
#       run: |
#         ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#     - name: Install dependencies and lint
#       run: |
#         npm install
      
      
#     #install sharp 

#     # - name: Install sharp for image optimization
#     #   run: |
#     #     npm install sharp
  
#     - name: Update Browserslist database
#       run: |
#         npx update-browserslist-db@latest

#     - name: Deploy to VPS
#       run: |
#         ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           cd /var/www/jimmystickman.com &&  # Single directory for both environments
#           git reset --hard &&
#           git pull origin ${{ github.ref_name }} &&  # Pull from the correct branch (dev or main)
#           npm install &&

#           if [ \"${{ github.ref_name }}\" == \"dev\" ]; then
#             # Load environment variables from .env.dev
#             export \$(grep -v '^#' .env.dev | xargs) && 
#             BUILD_DIR=build-dev NODE_ENV=production npm run build:dev &&

#             # Check if the jimmystickman-dev process exists, then restart, otherwise start it
#             if pm2 describe jimmystickman-dev > /dev/null; then
#               pm2 restart jimmystickman-dev
#             else
#               pm2 start npm --name \"jimmystickman-dev\" -- run start:dev  # Start dev process
#             fi
#             pm2 save
#           else
#             # Load environment variables from .env.prod
#             export \$(grep -v '^#' .env.prod | xargs) && 
#             NODE_ENV=production npm run build:prod &&  # Build for production

#             # Check if the jimmystickman-prod process exists, then restart, otherwise start it
#             if pm2 describe jimmystickman-prod > /dev/null; then
#               pm2 restart jimmystickman-prod
#             else
#               pm2 start npm --name \"jimmystickman-prod\" -- run start:prod --port 6003  # Start prod process
#             fi
#             pm2 save
#           fi

#           sudo /bin/systemctl restart nginx  # Restart Nginx to apply changes
#         "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main
#       - dev

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v2

#     - name: Set up SSH
#       uses: webfactory/ssh-agent@v0.5.3
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: Add VPS to known_hosts
#       run: |
#         ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#     - name: Deploy to VPS
#       run: |
#         ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           cd /var/www/jimmystickman.com &&
          
#           # Clean git state
#           # git reset --hard HEAD &&
#           # git clean -fd &&
#           git pull origin ${{ github.ref_name }} &&
          
#           # Install dependencies
#           npm install &&
#           npm install sharp &&
          
#           # Build based on branch
#           if [ '${{ github.ref_name }}' = 'dev' ]; then
#             # Copy environment file
#             [ -f .env.dev ] && cp .env.dev .env.local || echo '.env.dev not found'
            
#             # Build for development
#             BUILD_DIR=build-dev NODE_ENV=production npm run build:dev
            
#             # PM2 management
#             pm2 delete jimmystickman-dev 2>/dev/null || true
#             pm2 start npm --name 'jimmystickman-dev' -- run start:dev
#           else
#             # Copy environment file
#             [ -f .env.prod ] && cp .env.prod .env.local || echo '.env.prod not found'
            
#             # Build for production
#             NODE_ENV=production npm run build:prod
            
#             # PM2 management
#             pm2 delete jimmystickman-prod 2>/dev/null || true
#             pm2 start npm --name 'jimmystickman-prod' -- run start:prod
#           fi
          
#           pm2 save
#           sudo systemctl restart nginx
#           echo '‚úÖ Deployment completed successfully!'
#         "

# name: Deploy Frontend to VPS Optimized

# on:
#   push:
#     branches:
#       - main
#       - dev

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Install dependencies and build locally
#       run: |
#         npm install
#         npm install sharp
        
#         # Set correct environment file
#         if [ "${{ github.ref_name }}" = "dev" ]; then
#           [ -f .env.dev ] && cp .env.dev .env.local || echo '.env.dev not found'
#           BUILD_DIR=build-dev NODE_ENV=production npm run build:dev
#         else
#           [ -f .env.prod ] && cp .env.prod .env.local || echo '.env.prod not found'
#           NODE_ENV=production npm run build:prod
#         fi
        
#         # Create deployment package
#         mkdir -p deploy
#         cp -r .next public package.json package-lock.json next.config.js .env.local deploy/
#         tar -czf deploy.tar.gz deploy/

#     - name: Set up SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: Add VPS to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#     - name: Deploy built files
#       run: |
#         # Copy built files
#         scp -o ServerAliveInterval=30 deploy.tar.gz \
#           ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }}:/var/www/jimmystickman.com/
        
#         # Extract and restart
#         ssh -o ServerAliveInterval=30 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           cd /var/www/jimmystickman.com &&
          
#           # Backup current
#           tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz .next package.json .env.local 2>/dev/null || true
          
#           # Extract new
#           tar -xzf deploy.tar.gz --strip-components=1 &&
#           rm deploy.tar.gz
          
#           # Install only production dependencies
#           npm ci --omit=dev
          
#           # PM2 restart based on branch
#           if [ '${{ github.ref_name }}' = 'dev' ]; then
#             pm2 restart jimmystickman-dev || \
#             pm2 start npm --name 'jimmystickman-dev' -- run start:dev
#           else
#             pm2 restart jimmystickman-prod || \
#             pm2 start npm --name 'jimmystickman-prod' -- run start:prod
#           fi
          
#           pm2 save
#           sudo systemctl reload nginx
#           echo '‚úÖ Deployment completed successfully!'
#         "

# name: Deploy Frontend to VPS Optimized

# on:
#   push:
#     branches:
#       - main
#       - dev

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'
#         cache: 'npm'

#     - name: Install dependencies and build locally
#       run: |
#         npm ci
#         npm install sharp
        
#         # Set correct environment file based on branch
#         if [ "${{ github.ref_name }}" = "dev" ]; then
#           echo "Building for dev environment"
#           # Check if env file exists, if not create placeholder
#           if [ -f .env.dev ]; then
#             cp .env.dev .env.local
#             echo "Using .env.dev"
#           else
#             echo "WARNING: .env.dev not found, using .env.example if available"
#             [ -f .env.example ] && cp .env.example .env.local || true
#           fi
          
#           BUILD_DIR=build-dev NODE_ENV=production npm run build:dev
#         else
#           echo "Building for production environment"
#           if [ -f .env.prod ]; then
#             cp .env.prod .env.local
#             echo "Using .env.prod"
#           else
#             echo "WARNING: .env.prod not found, using .env.example if available"
#             [ -f .env.example ] && cp .env.example .env.local || true
#           fi
          
#           NODE_ENV=production npm run build:prod
#         fi
        
#         # Create deployment package with only necessary files
#         mkdir -p deploy
        
#         # Copy the built .next directory
#         cp -r .next/ deploy/.next/
        
#         # Copy public directory if it exists
#         [ -d public ] && cp -r public/ deploy/public/
        
#         # Copy package files
#         cp package.json package-lock.json deploy/
        
#         # Copy configuration files if they exist
#         [ -f next.config.js ] && cp next.config.js deploy/
#         [ -f next.config.mjs ] && cp next.config.mjs deploy/
#         [ -f next.config.ts ] && cp next.config.ts deploy/
        
#         # Copy environment file if it was created
#         [ -f .env.local ] && cp .env.local deploy/
        
#         # Create a list of what we're deploying (for debugging)
#         find deploy -type f | head -20 > deploy-files.txt
        
#         # Create deployment archive
#         tar -czf deploy.tar.gz deploy/
        
#         echo "Build completed successfully!"
#         echo "Deployment package created: $(du -h deploy.tar.gz | cut -f1)"

#     - name: Debug deployment files
#       run: |
#         echo "=== Deployment File Structure ==="
#         ls -la deploy/ || echo "No deploy directory"
#         echo "=== Files in deploy package ==="
#         cat deploy-files.txt || echo "No file list"
#         echo "=== Archive size ==="
#         ls -lh deploy.tar.gz || echo "No archive"

#     - name: Set up SSH
#       uses: webfactory/ssh-agent@v0.7.0
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: Add VPS to known_hosts
#       run: |
#         mkdir -p ~/.ssh
#         chmod 700 ~/.ssh
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
#         # ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts
#         chmod 600 ~/.ssh/known_hosts

#     - name: Deploy to VPS
#       run: |
#         echo "Starting deployment to VPS..."
        
#         # First, ensure the directory exists on VPS
#         ssh -p 22222 -i ~/.ssh/vps_key \
#           -o ConnectTimeout=30 \
#           -o ServerAliveInterval=30 \
#           ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           mkdir -p /var/www/jimmystickman.com
#         "
        
#         # Copy the deployment package
#         echo "Copying deployment package..."
#         scp -P 22222 -i ~/.ssh/vps_key \
#           -o ConnectTimeout=30 \
#           -o ServerAliveInterval=30 \
#           deploy.tar.gz \
#           ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }}:/var/www/jimmystickman.com/
        
#         # Execute deployment on VPS
#         echo "Executing deployment on VPS..."
#         ssh -p 22222 -i ~/.ssh/vps_key \
#           -o ConnectTimeout=30 \
#           -o ServerAliveInterval=30 \
#           ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           set -e  # Exit on any error
#           cd /var/www/jimmystickman.com
          
#           echo 'Current directory:'
#           pwd
#           ls -la
          
#           # Create backup of current deployment
#           BACKUP_FILE=\"backup-\$(date +%Y%m%d-%H%M%S).tar.gz\"
#           echo \"Creating backup: \$BACKUP_FILE\"
#           tar -czf \"\$BACKUP_FILE\" .next package.json package-lock.json .env.local 2>/dev/null || echo 'No previous files to backup'
          
#           # Remove old files (keep node_modules)
#           echo 'Cleaning old files...'
#           rm -rf .next package.json package-lock.json next.config.* .env.local
          
#           # Extract new deployment
#           echo 'Extracting new deployment...'
#           tar -xzf deploy.tar.gz --strip-components=1
#           rm deploy.tar.gz
          
#           # Install dependencies
#           echo 'Installing dependencies...'
#           npm ci --omit=dev
          
#           # Restart PM2 based on branch
#           if [ '${{ github.ref_name }}' = 'dev' ]; then
#             echo 'Starting/Restarting dev instance...'
#             pm2 delete jimmystickman-dev 2>/dev/null || true
#             pm2 start npm --name 'jimmystickman-dev' -- run start:dev
#           else
#             echo 'Starting/Restarting prod instance...'
#             pm2 delete jimmystickman-prod 2>/dev/null || true
#             pm2 start npm --name 'jimmystickman-prod' -- run start:prod
#           fi
          
#           pm2 save
          
#           # Reload nginx
#           sudo systemctl reload nginx
          
#           echo '‚úÖ Deployment completed successfully!'
#           echo 'Backup created: ' \$BACKUP_FILE
#         "
        
#         echo "üöÄ Deployment finished!"

#     - name: Cleanup
#       if: always()
#       run: |
#         rm -rf deploy deploy.tar.gz deploy-files.txt

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main
#       - dev

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v2

#     - name: Set up SSH
#       uses: webfactory/ssh-agent@v0.5.3
#       with:
#         ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#     - name: Add VPS to known_hosts
#       run: |
#         ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#     - name: Install dependencies and lint
#       run: |
#         yarn install

      
#     #install sharp 

#     # - name: Install sharp for image optimization
#     #   run: |
#     #     npm install sharp
  
#     - name: Update Browserslist database
#       run: |
#         npx update-browserslist-db@latest

#     - name: Deploy to VPS
#       run: |
#         ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#           cd /var/www/jimmystickman.com &&  # Single directory for both environments
#           git reset --hard &&
#           git pull origin ${{ github.ref_name }} &&  # Pull from the correct branch (dev or main)
#           npm install &&

#           if [ \"${{ github.ref_name }}\" == \"dev\" ]; then
#             # Load environment variables from .env.dev
#             export \$(grep -v '^#' .env.dev | xargs) && 
#             BUILD_DIR=build-dev NODE_ENV=production npm run build:dev &&

#             # Check if the jimmystickman-dev process exists, then restart, otherwise start it
#             if pm2 describe jimmystickman-dev > /dev/null; then
#               pm2 restart jimmystickman-dev
#             else
#               pm2 start npm --name \"jimmystickman-dev\" -- run start:dev  # Start dev process
#             fi
#             pm2 save
#           else
#             # Load environment variables from .env.prod
#             export \$(grep -v '^#' .env.prod | xargs) && 
#             NODE_ENV=production npm run build:prod &&  # Build for production

#             # Check if the jimmystickman-prod process exists, then restart, otherwise start it
#             if pm2 describe jimmystickman-prod > /dev/null; then
#               pm2 restart jimmystickman-prod
#             else
#               pm2 start npm --name \"jimmystickman-prod\" -- run start:prod  # Start prod process
#             fi
#             pm2 save
#           fi

#           sudo /bin/systemctl restart nginx  # Restart Nginx to apply changes
#         "

# name: Deploy Frontend to VPS

# on:
#   push:
#     branches:
#       - main
#       - dev

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

#       - name: Add VPS to known_hosts
#         run: |
#           ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

#       - name: Install dependencies locally
#         run: |
#           npm ci
#           npx update-browserslist-db@latest

#       - name: Deploy to VPS
#         run: |
#           set -e
          
#           ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
#             set -e
            
#             echo 'üöÄ ========== STARTING DEPLOYMENT =========='
            
#             # Define deployment directory
#             DEPLOY_DIR=\"/var/www/jimmystickman.com\"
            
#             # Create directory if it doesn't exist
#             if [ ! -d \"\$DEPLOY_DIR\" ]; then
#               echo 'üìÅ Creating deployment directory...'
#               sudo mkdir -p \"\$DEPLOY_DIR\"
#               sudo chown -R $USER:$USER \"\$DEPLOY_DIR\"
#             fi
            
#             cd \"\$DEPLOY_DIR\"
            
#             echo 'üìÇ Current directory:'
#             pwd
#             echo 'üì¶ Directory contents before deployment:'
#             ls -la
            
#             # Initialize git if needed
#             if [ ! -d .git ]; then
#               echo 'üîß Initializing git repository...'
#               git init
#               git remote add origin https://github.com/${{ github.repository }}.git
#             fi
            
#             # Fetch and reset to latest code
#             echo '‚¨áÔ∏è Fetching latest code...'
#             git fetch origin
#             git reset --hard origin/${{ github.ref_name }}
            
#             echo 'üìù Latest commit:'
#             git log --oneline -1
            
#             echo 'üîß Installing dependencies...'
#             npm ci --omit=dev
            
#             echo 'üèóÔ∏è Building application...'
            
#             if [ \"${{ github.ref_name }}\" == \"dev\" ]; then
#               # ===== DEV BRANCH DEPLOYMENT =====
#               echo 'üéØ Deploying DEV environment...'
              
#               # Set environment variables
#               if [ -f .env.dev ]; then
#                 echo 'üìÑ Using .env.dev file'
#                 export \$(grep -v '^#' .env.dev | xargs)
#               else
#                 echo '‚ö†Ô∏è Warning: .env.dev not found'
#               fi
              
#               # Build for dev
#               BUILD_DIR=build-dev NODE_ENV=production npm run build:dev
              
#               # Restart PM2 process
#               echo 'üîÑ Managing PM2 dev process...'
#               pm2 delete jimmystickman-dev 2>/dev/null || true
#               pm2 start npm --name \"jimmystickman-dev\" -- run start:dev
              
#             else
#               # ===== MAIN BRANCH (PRODUCTION) DEPLOYMENT =====
#               echo 'üöÄ Deploying PRODUCTION environment...'
              
#               # Set environment variables
#               if [ -f .env.prod ]; then
#                 echo 'üìÑ Using .env.prod file'
#                 export \$(grep -v '^#' .env.prod | xargs)
#               else
#                 echo '‚ö†Ô∏è Warning: .env.prod not found'
#               fi
              
#               # Build for production
#               NODE_ENV=production npm run build:prod
              
#               # Restart PM2 process
#               echo 'üîÑ Managing PM2 production process...'
#               pm2 delete jimmystickman-prod 2>/dev/null || true
#               pm2 start npm --name \"jimmystickman-prod\" -- run start:prod
#             fi
            
#             # Save PM2 configuration
#             pm2 save
            
#             # Reload nginx
#             echo 'üåê Reloading nginx...'
#             sudo systemctl reload nginx
            
#             # ===== VERIFICATION =====
#             echo '‚úÖ ========== DEPLOYMENT COMPLETE =========='
#             echo ''
#             echo 'üìã Verification:'
#             echo '1. PM2 Status:'
#             pm2 list | grep jimmystickman || echo 'No jimmystickman processes found'
#             echo ''
#             echo '2. Directory contents after deployment:'
#             ls -la
#             echo ''
#             echo '3. Build directory exists:'
#             [ -d .next ] && echo '‚úÖ .next directory found' || echo '‚ùå .next directory missing'
#             echo ''
#             echo '4. Application is running on:'
#             echo '   - Dev: http://dev.jimmystickman.com'
#             echo '   - Prod: http://jimmystickman.com'
#             echo ''
#             echo 'üìä Deployment Summary:'
#             echo '   Branch: ${{ github.ref_name }}'
#             echo '   Commit: ' \$(git log --oneline -1)
#             echo '   Time: ' \$(date)
#             echo '============================================'
#           "
          
#           echo 'üéâ GitHub Actions deployment workflow completed!'

#       - name: Deployment Success Notification
#         if: success()
#         run: |
#           echo '‚úÖ Deployment successful!'
#           echo 'Branch: ${{ github.ref_name }}'
#           echo 'Commit: ${{ github.sha }}'

#       - name: Deployment Failure Notification
#         if: failure()
#         run: |
#           echo '‚ùå Deployment failed!'
#           echo 'Please check the logs above for errors.'
#           echo 'Branch: ${{ github.ref_name }}'
#           echo 'Commit: ${{ github.sha }}'

name: Deploy Frontend to VPS

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add VPS to known_hosts
        run: |
          ssh-keyscan -p 22222 ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts


      - name: Deploy to VPS
        run: |
          set -e
          
          ssh -p 22222 ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "
            set -e
            
            echo 'üöÄ ========== STARTING DEPLOYMENT =========='
            
            DEPLOY_DIR=\"/var/www/jimmystickman.com\"
            
            if [ ! -d \"\$DEPLOY_DIR\" ]; then
              echo 'üìÅ Creating deployment directory...'
              sudo mkdir -p \"\$DEPLOY_DIR\"
              sudo chown -R $USER:$USER \"\$DEPLOY_DIR\"
            fi
            
            cd \"\$DEPLOY_DIR\"
            
            echo 'üìÇ Current directory:'
            pwd
            
            # Initialize git if needed
            if [ ! -d .git ]; then
              echo 'üîß Initializing git repository...'
              git init
              git remote add origin https://github.com/${{ github.repository }}.git
            fi
            
            # Fetch and reset to latest code
            echo '‚¨áÔ∏è Fetching latest code...'
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            
            echo 'üìù Latest commit:'
            git log --oneline -1
            
            # ===== CRITICAL FIX: INSTALL DEPENDENCIES BEFORE CHECKING FILES =====
            echo 'üì¶ Installing ALL dependencies...'
            npm ci
            
            echo 'üîç Checking TypeScript configuration...'
            if [ -f tsconfig.json ]; then
              echo 'üìÑ tsconfig.json found:'
              cat tsconfig.json | grep -A 10 '"paths"'
            elif [ -f jsconfig.json ]; then
              echo 'üìÑ jsconfig.json found:'
              cat jsconfig.json | grep -A 10 '"paths"'
            else
              echo '‚ö†Ô∏è No TypeScript/JavaScript config found!'
            fi
            
            echo 'üîç Checking if @/lib directory exists...'
            find . -type d -name "lib" | head -5
            ls -la ./lib/ 2>/dev/null || echo 'No ./lib directory'
            ls -la ./src/lib/ 2>/dev/null || echo 'No ./src/lib directory'
            
            echo 'üèóÔ∏è Building application...'
            
            if [ \"${{ github.ref_name }}\" == \"dev\" ]; then
              # ===== DEV BRANCH DEPLOYMENT =====
              echo 'üéØ Deploying DEV environment...'
              
              # Use .env.dev if exists
              if [ -f .env.dev ]; then
                echo 'üìÑ Using .env.dev file'
                cp .env.dev .env.local
              else
                echo '‚ö†Ô∏è Warning: .env.dev not found, checking for .env'
                [ -f .env ] && cp .env .env.local || echo 'No .env file found'
              fi
              
              # Build for dev
              BUILD_DIR=build-dev NODE_ENV=production npm run build:dev
              
              # Restart PM2 process
              echo 'üîÑ Managing PM2 dev process...'
              pm2 delete jimmystickman-dev 2>/dev/null || true
              pm2 start npm --name \"jimmystickman-dev\" -- run start:dev
              
            else
              # ===== MAIN BRANCH (PRODUCTION) DEPLOYMENT =====
              echo 'üöÄ Deploying PRODUCTION environment...'
              
              # Use .env.prod if exists
              if [ -f .env.prod ]; then
                echo 'üìÑ Using .env.prod file'
                cp .env.prod .env.local
              else
                echo '‚ö†Ô∏è Warning: .env.prod not found, checking for .env'
                [ -f .env ] && cp .env .env.local || echo 'No .env file found'
              fi
              
              # Build for production
              NODE_ENV=production npm run build:prod
              
              # Restart PM2 process
              echo 'üîÑ Managing PM2 production process...'
              pm2 delete jimmystickman-prod 2>/dev/null || true
              pm2 start npm --name \"jimmystickman-prod\" -- run start:prod
            fi
            
            pm2 save
            
            echo 'üåê Reloading nginx...'
            sudo systemctl reload nginx
            
            echo '‚úÖ ========== DEPLOYMENT COMPLETE =========='
          "

